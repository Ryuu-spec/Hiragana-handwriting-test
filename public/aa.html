<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>íˆë¼ê°€ë‚˜ ì±„ì ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #2b5aad;
    --paper: #eef4ff;
    --red: #e05555;
    --gold: #2b5aad;
    --green: #3a9e72;
    --orange: #f0a500;
    --blue: #5b8fee;
    --border: #c5d8f8;
    --shadow: rgba(43,90,173,0.10);
    --accent: #4a7de8;
    --card-bg: #ffffff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #e8f0fe;
    color: #1a2e5a;
    font-family: 'Noto Sans KR', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  header {
    background: #2b5aad;
    color: #ffffff;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 3px solid #7aaeff;
    flex-shrink: 0;
  }
  .logo { font-family: 'Noto Serif JP', serif; font-size: 1.15rem; letter-spacing: 0.05em; }
  .logo span { color: var(--gold); }
  .api-btn {
    background: transparent;
    border: 1px solid var(--gold);
    color: var(--gold);
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 0.72rem;
    cursor: pointer;
    font-family: 'Noto Sans KR', sans-serif;
    transition: all 0.2s;
  }
  .api-btn:hover { background: var(--gold); color: var(--ink); }

  /* LAYOUT */
  main {
    display: grid;
    grid-template-columns: 1fr 480px;
    flex: 1;
    overflow: hidden;
  }

  /* CENTER */
  .canvas-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    gap: 14px;
    overflow-y: auto;
    background: #e8f0fe;
  }

  /* ë¬¸ì ì„ íƒ ë²„íŠ¼ 5ê°œ */
  .char-selector {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  .char-selector { flex-direction: column; align-items: center; gap: 0; }
  .char-selector-row { display: flex; gap: 10px; }
  .char-btn-wrap {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
  }
  .score-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem; font-weight: 700;
    background: #2b5aad; color: white;
    padding: 2px 7px; border-radius: 20px;
    opacity: 0; transition: opacity 0.3s;
    white-space: nowrap;
  }
  .score-badge.visible { opacity: 1; }
  .score-badge.grade-a { background: #2b5aad; }
  .score-badge.grade-b { background: #3a9e72; }
  .score-badge.grade-c { background: #f0a500; }
  .score-badge.grade-d { background: #e05555; }
  .char-btn {
    width: 62px;
    height: 66px;
    background: white;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'Noto Serif JP', serif;
    font-size: 1.6rem;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
  }
  .char-btn:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
  .char-btn.active { background: #2b5aad; color: white; border-color: #2b5aad; }
  .char-btn .romaji-small {
    font-family: 'DM Mono', monospace;
    font-size: 0.48rem;
    opacity: 0.5;
    line-height: 1;
  }
  .char-btn.active .romaji-small { opacity: 0.65; }

  /* í˜„ì¬ ë¬¸ì */
  .target-char {
    font-family: 'Noto Serif JP', serif;
    font-size: 4.5rem;
    line-height: 1;
    text-align: center;
  }
  .target-char .romaji {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    color: #999;
    margin-top: 4px;
  }

  /* ìº”ë²„ìŠ¤ */
  .canvas-wrap { position: relative; display: inline-block; }
  #guideCanvas {
    position: absolute; top: 0; left: 0;
    pointer-events: none; z-index: 1;
    opacity: 1;
  }
  #drawCanvas {
    display: block; position: relative; z-index: 2;
    border: 2px solid #c5d8f8; border-radius: 12px;
    background: white; cursor: crosshair; touch-action: none;
    box-shadow: 0 4px 20px rgba(43,90,173,0.12);
  }

  .canvas-info {
    display: flex; gap: 20px;
    font-size: 0.73rem; color: #aaa;
    font-family: 'DM Mono', monospace;
    align-items: center;
  }
  .stroke-badge {
    background: #2b5aad; color: white;
    padding: 2px 8px; border-radius: 10px;
    font-size: 0.78rem;
  }

  .btn-row { display: flex; gap: 10px; }
  .btn {
    padding: 10px 24px; border-radius: 8px; border: none;
    font-family: 'Noto Sans KR', sans-serif; font-size: 0.88rem;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-clear { background: #f0ece0; color: var(--ink); border: 1.5px solid var(--border); }
  .btn-clear:hover { background: #e8e2d0; }
  .btn-score { background: #2b5aad; color: white; font-weight: 700; }
  .btn-score:hover { background: #1e4694; transform: translateY(-1px); }

  /* RIGHT PANEL */
  .feedback-panel {
    border-left: 1px solid #c5d8f8;
    display: flex; flex-direction: column;
    overflow: hidden; background: #f5f8ff;
  }
  .feedback-header {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    font-size: 0.72rem; letter-spacing: 0.1em;
    text-transform: uppercase; color: #888; flex-shrink: 0;
  }
  .feedback-body { flex: 1; overflow-y: auto; padding: 20px; }

  .empty-state {
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    height: 100%; color: #bbb; text-align: center; gap: 10px;
  }
  .empty-state .big { font-family: 'Noto Serif JP', serif; font-size: 3.5rem; opacity: 0.12; }
  .empty-state p { font-size: 0.82rem; line-height: 1.7; }

  .loading { display: none; text-align: center; padding: 40px 20px; color: #888; }
  .loading.on { display: block; }
  .spinner {
    width: 30px; height: 30px;
    border: 3px solid #f0ece0; border-top-color: var(--ink);
    border-radius: 50%; animation: spin 0.8s linear infinite;
    margin: 0 auto 14px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .result { display: none; }
  .result.on { display: block; }

  .total-score {
    text-align: center; padding: 18px 0;
    border-bottom: 1px solid var(--border); margin-bottom: 16px;
  }
  .grade {
    font-family: 'Noto Serif JP', serif;
    font-size: 3rem; font-weight: 700; line-height: 1;
  }
  .grade.A { color: #2b5aad; }
  .grade.B { color: #3a9e72; }
  .grade.C { color: #f0a500; }
  .grade.D { color: #e05555; }
  .score-num { font-family: 'DM Mono', monospace; font-size: 1rem; color: #666; margin-top: 4px; }

  .rubric-item { margin-bottom: 12px; }
  .rubric-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .rubric-name { font-size: 0.76rem; font-weight: 700; }
  .rubric-val { font-family: 'DM Mono', monospace; font-size: 0.73rem; color: #666; }
  .bar-bg { height: 6px; background: #f0ece0; border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }

  .ai-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
  .ai-section h4 { font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase; color: #888; margin-bottom: 10px; }
  .card {
    border-left: 3px solid #2b5aad; background: #eef4ff;
    padding: 10px 13px; border-radius: 0 8px 8px 0;
    font-size: 0.82rem; line-height: 1.7; margin-bottom: 8px;
  }
  .card.err { border-left-color: #e05555; background: #fff0f0; }
  .card.tip { border-left-color: #3a9e72; background: #f0fff8; }

  /* MODAL */
  .modal-bg {
    display: none; position: fixed; inset: 0;
    background: rgba(26,26,46,0.6); z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-bg.on { display: flex; }
  .modal {
    background: white; border-radius: 12px;
    padding: 30px; width: 380px; max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .modal h3 { font-size: 1.05rem; margin-bottom: 8px; }
  .modal p { font-size: 0.8rem; color: #666; margin-bottom: 16px; line-height: 1.6; }
  .modal input {
    width: 100%; padding: 9px 13px;
    border: 1.5px solid var(--border); border-radius: 8px;
    font-family: 'DM Mono', monospace; font-size: 0.82rem;
    margin-bottom: 14px; outline: none; transition: border-color 0.2s;
  }
  .modal input:focus { border-color: var(--ink); }
  .modal-btns { display: flex; gap: 8px; justify-content: flex-end; }
  .btn-cancel { padding: 7px 18px; background: #f0ece0; border: none; border-radius: 6px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; }
  .btn-save { padding: 7px 18px; background: var(--ink); color: white; border: none; border-radius: 6px; cursor: pointer; font-family: 'Noto Sans KR', sans-serif; }
</style>
</head>
<body>

<header style="padding:8px 24px;">
  <div class="logo" style="font-size:0.85rem; opacity:0.7;">íˆë¼ê°€ë‚˜ ì±„ì ê¸°</div>
</header>

<main>
  <div class="canvas-area">

    <!-- ã‚ã„ã†ãˆãŠ 5ê°œ ë²„íŠ¼ -->
    <div class="char-selector" id="charSelector"></div>



    <!-- ìº”ë²„ìŠ¤ -->
    <div class="canvas-wrap">
      <canvas id="guideCanvas" width="300" height="300"></canvas>
      <canvas id="drawCanvas" width="300" height="300"></canvas>
    </div>



    <div class="btn-row">
      <button class="btn btn-clear" onclick="clearCanvas()">ì§€ìš°ê¸°</button>
      <button class="btn btn-score" onclick="scoreWriting()">AI ì±„ì í•˜ê¸°</button>
    </div>

  </div>

  <!-- í”¼ë“œë°± íŒ¨ë„ -->
  <div class="feedback-panel">
    <div class="feedback-header">ì±„ì  ê²°ê³¼ Â· í”¼ë“œë°±</div>
    <div class="feedback-body" id="feedbackBody">
      <div class="empty-state" id="emptyState">
        <div class="big">ã‚</div>
        <p>ìœ„ì—ì„œ ê¸€ìë¥¼ ì„ íƒí•˜ê³ <br>ìº”ë²„ìŠ¤ì— ì¨ë³´ì„¸ìš”.<br><br>AI ì±„ì í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´<br>í”¼ë“œë°±ì´ ë‚˜ì™€ìš”.</p>
      </div>
      <div class="loading" id="loadingEl">
        <div class="spinner"></div>
        <p>AIê°€ ì±„ì  ì¤‘ì´ì—ìš”...</p>
      </div>
      <div class="result" id="resultEl">
        <div class="total-score">
          <div class="grade" id="gradeEl">S</div>
          <div class="score-num" id="scoreEl">95 / 100</div>
        </div>
        <div id="rubricEl"></div>
        <div class="ai-section">
          <h4>AI í”¼ë“œë°±</h4>
          <div id="feedbackEl"></div>
        </div>
      </div>
    </div>
  </div>
</main>



<script>
// â”€â”€ ë°ì´í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARS = [
  { char: 'ã‚', romaji: 'a',  strokes: 3 },
  { char: 'ã„', romaji: 'i',  strokes: 2 },
  { char: 'ã†', romaji: 'u',  strokes: 2 },
  { char: 'ãˆ', romaji: 'e',  strokes: 2 },
  { char: 'ãŠ', romaji: 'o',  strokes: 3 },
];

// â”€â”€ ê·œì¹™ ê¸°ë°˜ í•„ìˆœ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ê° íš: { dir: ë°©í–¥ë²¡í„°ê¸°ì¤€, xStart: ì‹œì‘Xìœ„ì¹˜(0=left,1=right), yStart: ì‹œì‘Yìœ„ì¹˜(0=top,1=bot) }
// ë°©í–¥: 'right'=ì˜¤ë¥¸ìª½, 'down'=ì•„ë˜, 'left'=ì™¼ìª½, 'down-right'=ëŒ€ê°ì„  ë“±
const STROKE_RULES = {
  'ã‚': [
    { label: '1íš: ê°€ë¡œíš (ì™¼â†’ì˜¤)', xDir: 1, yDir: 0, startSide: 'top-left'  },
    { label: '2íš: ì„¸ë¡œíš (ìœ„â†’ì•„ë˜)', xDir: 0, yDir: 1, startSide: 'top-center' },
    { label: '3íš: ë‘¥ê·¼ ë§ˆë¬´ë¦¬ (ì˜¤ë¥¸ìª½â†’ì™¼ìª½ ê³¡ì„ )', xDir: -0.5, yDir: 0.5, startSide: 'top-right' },
  ],
  'ã„': [
    { label: '1íš: ì™¼ìª½ ì„¸ë¡œ (ìœ„â†’ì•„ë˜)', xDir: 0.2, yDir: 1, startSide: 'top-left' },
    { label: '2íš: ì˜¤ë¥¸ìª½ ì„¸ë¡œ (ìœ„â†’ì•„ë˜ ê¸¸ê²Œ)', xDir: -0.3, yDir: 1, startSide: 'top-right' },
  ],
  'ã†': [
    { label: '1íš: ìœ„ ì /ê°€ë¡œ', xDir: 0.5, yDir: 0.2, startSide: 'top-center' },
    { label: '2íš: ê³¡ì„  (ì˜¤ë¥¸ìª½ ìœ„â†’ì•„ë˜â†’ì™¼ìª½)', xDir: -0.5, yDir: 0.5, startSide: 'top-right' },
  ],
  'ãˆ': [
    { label: '1íš: ê°€ë¡œíš (ì™¼â†’ì˜¤)', xDir: 1, yDir: 0, startSide: 'top-left' },
    { label: '2íš: ì„¸ë¡œ+ê³¡ì„  (ìœ„â†’ì•„ë˜â†’ì™¼ìª½)', xDir: -0.3, yDir: 1, startSide: 'top-center' },
  ],
  'ãŠ': [
    { label: '1íš: ê°€ë¡œíš (ì™¼â†’ì˜¤)', xDir: 1, yDir: 0, startSide: 'top-left' },
    { label: '2íš: ì„¸ë¡œíš (ìœ„â†’ì•„ë˜)', xDir: 0, yDir: 1, startSide: 'top-center' },
    { label: '3íš: ë‘¥ê·¼ ë§ˆë¬´ë¦¬ (ì˜¤ë¥¸ìª½â†’ì™¼ìª½ ê³¡ì„ )', xDir: -0.5, yDir: 0.5, startSide: 'top-right' },
  ],
};

// â”€â”€ íš ë²¡í„° ë¶„ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function analyzeStroke(pts) {
  if (pts.length < 2) return null;
  const first = pts[0];
  const last  = pts[pts.length - 1];
  const dx = last.x - first.x;
  const dy = last.y - first.y;
  const len = Math.sqrt(dx*dx + dy*dy);
  return { dx, dy, len, nx: dx/len, ny: dy/len, startX: first.x, startY: first.y };
}

function scoreStrokeOrder(strokes, canvasSize) {
  const rules = STROKE_RULES[current.char];
  const expected = rules ? rules.length : current.strokes;

  // íš ìˆ˜ ë¶ˆì¼ì¹˜ â†’ í¬ê²Œ ê°ì 
  if (strokes.length !== expected) {
    const diff = Math.abs(strokes.length - expected);
    return Math.max(0, 25 - diff * 8);
  }

  // íš ìˆ˜ ì¼ì¹˜ â†’ ë°©í–¥ ì²´í¬ (ëŒ€ì¶© ë§ìœ¼ë©´ ë§Œì )
  if (!rules) return 25;
  let score = 25;
  strokes.forEach((pts, i) => {
    const rule = rules[i];
    const vec  = analyzeStroke(pts);
    if (!vec) return;
    const rLen = Math.sqrt(rule.xDir*rule.xDir + rule.yDir*rule.yDir);
    const dot  = (vec.nx * rule.xDir/rLen) + (vec.ny * rule.yDir/rLen);
    // dot > 0.3ì´ë©´ "ëŒ€ì¶© ë§ìŒ" â†’ ë§Œì  ìœ ì§€, ê·¸ ì´í•˜ë©´ ê°ì 
    if (dot < 0.3) score -= 6;
  });
  return Math.max(0, score);
}

// â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API í‚¤ëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬ (Vercel í™˜ê²½ë³€ìˆ˜)
let current     = CHARS[0];
let strokes     = [];
let curStroke   = [];
let isDrawing   = false;
let charScores  = {};

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  buildButtons();
  selectChar(CHARS[0]);
  initCanvas();
});

function buildButtons() {
  const wrap = document.getElementById('charSelector');
  wrap.className = 'char-selector-row';
  CHARS.forEach(cd => {
    const outer = document.createElement('div');
    outer.className = 'char-btn-wrap';

    const badge = document.createElement('div');
    badge.className = 'score-badge';
    badge.id = 'badge-' + cd.char;
    badge.textContent = '';

    const btn = document.createElement('button');
    btn.className = 'char-btn';
    btn.id = 'cbtn-' + cd.char;

    const cSpan = document.createElement('span'); cSpan.textContent = cd.char;
    const rSpan = document.createElement('span'); rSpan.className = 'romaji-small'; rSpan.textContent = cd.romaji;

    btn.append(cSpan, rSpan);
    btn.addEventListener('click', () => selectChar(cd));
    outer.append(badge, btn);
    wrap.appendChild(outer);
  });
}

function selectChar(cd) {
  current = cd;
  document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('cbtn-' + cd.char);
  if (btn) btn.classList.add('active');
  // (í‘œì‹œ ìš”ì†Œ ì‚­ì œë¨ - ì°¸ì¡° ì œê±°)
  clearCanvas();
  resetResult();
  drawGuide();
}

// â”€â”€ ìº”ë²„ìŠ¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initCanvas() {
  const c = document.getElementById('drawCanvas');
  c.addEventListener('mousedown',  e => startDraw(e));
  c.addEventListener('mousemove',  e => continueDraw(e));
  c.addEventListener('mouseup',    () => endDraw());
  c.addEventListener('mouseleave', () => endDraw());
  c.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e.touches[0]); }, { passive: false });
  c.addEventListener('touchmove',  e => { e.preventDefault(); continueDraw(e.touches[0]); }, { passive: false });
  c.addEventListener('touchend',   e => { e.preventDefault(); endDraw(); }, { passive: false });
}

function getXY(e) {
  const c    = document.getElementById('drawCanvas');
  const rect = c.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) * (c.width  / rect.width),
    y: (e.clientY - rect.top)  * (c.height / rect.height),
    t: Date.now()
  };
}

function startDraw(e)    { isDrawing = true; curStroke = [getXY(e)]; }
function endDraw()       {
  if (!isDrawing) return;
  isDrawing = false;
  if (curStroke.length) {
    strokes.push([...curStroke]);

  }
  curStroke = [];
}
function continueDraw(e) {
  if (!isDrawing) return;
  const pos = getXY(e);
  const ctx = document.getElementById('drawCanvas').getContext('2d');
  if (curStroke.length) {
    const prev = curStroke[curStroke.length - 1];
    ctx.beginPath();
    ctx.moveTo(prev.x, prev.y);
    ctx.lineTo(pos.x, pos.y);
    ctx.strokeStyle = '#1a1a2e';
    ctx.lineWidth   = 3.5;
    ctx.lineCap     = 'round';
    ctx.lineJoin    = 'round';
    ctx.stroke();
  }
  curStroke.push(pos);
}

function clearCanvas() {
  const c = document.getElementById('drawCanvas');
  c.getContext('2d').clearRect(0, 0, c.width, c.height);
  strokes = []; curStroke = [];
}

function drawGuide() {
  const c   = document.getElementById('guideCanvas');
  const ctx = c.getContext('2d');
  ctx.clearRect(0, 0, c.width, c.height);
  // ì‹­ì ê°€ì´ë“œë¼ì¸
  ctx.setLineDash([6, 5]);
  ctx.strokeStyle = 'rgba(43, 90, 173, 0.25)';
  ctx.lineWidth = 1.2;
  // ê°€ë¡œì„ 
  ctx.beginPath();
  ctx.moveTo(0, c.height / 2);
  ctx.lineTo(c.width, c.height / 2);
  ctx.stroke();
  // ì„¸ë¡œì„ 
  ctx.beginPath();
  ctx.moveTo(c.width / 2, 0);
  ctx.lineTo(c.width / 2, c.height);
  ctx.stroke();
  ctx.setLineDash([]);
}

function toggleGuide() {
  document.getElementById('guideCanvas').style.opacity =
    document.getElementById('guideToggle').checked ? '0.12' : '0';
}

// â”€â”€ ì±„ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scoreWriting() {
  if (!strokes.length) { alert('ë¨¼ì € ê¸€ìë¥¼ ì¨ì£¼ì„¸ìš”!'); return; }


  showLoading(true);
  try {
    // ê·œì¹™ ê¸°ë°˜ í•„ìˆœ ì ìˆ˜ ë¨¼ì € ê³„ì‚°
    const c = document.getElementById('drawCanvas');
    const strokeOrderScore = scoreStrokeOrder(strokes, c.width);

    const img    = c.toDataURL('image/png').split(',')[1];
    const result = await callGemini(img, strokeOrderScore);
    showResult(result);
  } catch(err) {
    showLoading(false);
    resetResult();
    alert('ì±„ì  ì˜¤ë¥˜: ' + err.message);
  }
}

async function callGemini(imgB64, strokeOrderScore) {
  const res = await fetch('/api/gemini', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      char: current.char,
      romaji: current.romaji,
      strokes: strokes.length,
      expectedStrokes: current.strokes,
      strokeOrderScore,
      image: imgB64
    })
  });

  if (!res.ok) {
    const e = await res.json();
    throw new Error(e.error || `HTTP ${res.status}`);
  }

  const parsed = await res.json();
  // í•„ìˆœ ì ìˆ˜ ê°•ì œ ê³ ì •
  if (parsed.scores) parsed.scores['í•„ìˆœ'] = strokeOrderScore;
  parsed.total = Object.values(parsed.scores).reduce((a,b)=>a+b,0);
  const t = parsed.total;
  parsed.grade = t>=90?'A':t>=80?'B':t>=70?'C':'D';
  return parsed;
}

// â”€â”€ ê²°ê³¼ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(r) {
  showLoading(false);
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('resultEl').classList.add('on');

  const grade = r.grade || 'B';
  const total = r.total || 0;

  const gradeEl = document.getElementById('gradeEl');
  gradeEl.textContent = grade;
  gradeEl.className   = 'grade ' + grade;
  document.getElementById('scoreEl').textContent = `${total} / 100`;

  // ì ìˆ˜ ë±ƒì§€ ì—…ë°ì´íŠ¸
  const badge = document.getElementById('badge-' + current.char);
  if (badge) {
    badge.textContent = total + 'ì ';
    badge.className = 'score-badge visible grade-' + grade.toLowerCase();
  }
  charScores[current.char] = { grade, total };

  // ë£¨ë¸Œë¦­ ë°”
  const rubrics = [
    { name: 'í˜•íƒœ ì •í™•ì„±', key: 'í˜•íƒœì •í™•ì„±', max: 35, color: '#1a1a2e' },
    { name: 'í•„ìˆœ',        key: 'í•„ìˆœ',       max: 25, color: '#c9a84c' },
    { name: 'íš ë°©í–¥',     key: 'íšë°©í–¥',     max: 20, color: '#2980b9' },
    { name: 'ëë§ºìŒ',      key: 'ëë§ºìŒ',     max: 10, color: '#2d6a4f' },
    { name: 'ê· í˜•Â·ë¹„ìœ¨',   key: 'ê· í˜•ë¹„ìœ¨',   max: 10, color: '#e67e22' },
  ];
  document.getElementById('rubricEl').innerHTML = rubrics.map(rb => {
    const sc  = r.scores?.[rb.key] ?? 0;
    const pct = Math.round((sc / rb.max) * 100);
    return `<div class="rubric-item">
      <div class="rubric-row">
        <span class="rubric-name">${rb.name}</span>
        <span class="rubric-val">${sc} / ${rb.max}</span>
      </div>
      <div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${rb.color}"></div></div>
    </div>`;
  }).join('');

  // í…ìŠ¤íŠ¸ í”¼ë“œë°±
  let fb = '';
  if (r.overall)        fb += `<div class="card">${r.overall}</div>`;
  (r.errors||[]).forEach(e => { fb += `<div class="card err">âš  ${e}</div>`; });
  (r.tips  ||[]).forEach(t => { fb += `<div class="card tip">ğŸ’¡ ${t}</div>`; });
  if (r.korean_pattern) fb += `<div class="card err">ğŸ‡°ğŸ‡· ${r.korean_pattern}</div>`;
  document.getElementById('feedbackEl').innerHTML = fb;
}

function showLoading(on) {
  document.getElementById('loadingEl').classList.toggle('on', on);
  if (on) {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('resultEl').classList.remove('on');
  }
}

function resetResult() {
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('resultEl').classList.remove('on');
  document.getElementById('loadingEl').classList.remove('on');
}


</script>
</body>
</html>
