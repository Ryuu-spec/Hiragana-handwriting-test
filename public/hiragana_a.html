<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>히라가나 AI 트레이너 - あ행</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Sans+JP:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; height: 100%; }
        .jp-font { font-family: 'Klee One', 'Noto Sans JP', sans-serif; }
        .app-container { display: flex; height: 100vh; width: 100%; }
        .panel { display: flex; flex-direction: column; padding: 30px; height: 100%; }
        .left-panel { flex: 1.2; background-color: #ffffff; }
        .right-panel { flex: 0.8; background-color: #f1f7ff; border-left: 1px solid #e2e8f0; }
        .char-bar { display: flex; gap: 12px; margin-bottom: 30px; padding-top: 20px; }
        .char-item { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; }
        .score-badge { position: absolute; top: -24px; background: #619bd1; color: white; font-size: 11px; font-weight: 800; padding: 3px 10px; border-radius: 8px; opacity: 0; visibility: hidden; transition: all 0.3s; transform: translateY(10px); z-index: 10; }
        .score-badge.visible { opacity: 1; visibility: visible; transform: translateY(0); }
        .char-btn { width: 100%; height: 65px; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: 600; border-radius: 16px; border: 2px solid #f1f5f9; background: #ffffff; color: #94a3b8; transition: all 0.2s; }
        .char-btn.active { background-color: #619bd1; color: white; border-color: #619bd1; }
        .canvas-area { flex: 1; background: #ffffff; border: 2px solid #f1f5f9; border-radius: 24px; position: relative; overflow: hidden; }
        #drawing-canvas { cursor: crosshair; touch-action: none; width: 100%; height: 100%; }
        .result-card { background: white; border-radius: 24px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 280px; width: 100%; border: 1px solid #e2e8f0; }
        .feedback-box { margin-top: 25px; padding: 20px; background: #f8fafc; border-radius: 16px; width: 100%; text-align: center; }
    </style>
</head>
<body>
    <div class="app-container">
        <section class="panel left-panel">
            <div id="char-selection" class="char-bar jp-font"></div>
            <div class="canvas-area"><canvas id="drawing-canvas"></canvas></div>
            <div class="mt-8 flex gap-4">
                <button id="clear-btn" class="flex-1 py-4 bg-slate-100 text-slate-500 font-bold rounded-2xl text-sm hover:bg-slate-200">다시 쓰기</button>
                <button id="submit-btn" class="flex-[1.8] py-4 bg-[#619bd1] text-white font-bold rounded-2xl shadow-lg flex items-center justify-center gap-3 text-sm hover:bg-[#5088bd]">
                    <span id="btn-text">채점하기</span>
                    <div id="loader" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
        </section>
        <section class="panel right-panel">
            <div id="result-container" class="result-card">
                <div id="view-idle" class="flex flex-col items-center">
                    <p class="text-xs text-slate-400 font-medium text-center leading-relaxed">히라가나를 작성한 후<br>채점 버튼을 눌러주세요.</p>
                </div>
                <div id="view-result" class="hidden w-full flex flex-col items-center">
                    <div class="flex items-baseline gap-1"><span id="score-val" class="text-7xl font-black text-[#619bd1]">0</span><span class="text-2xl font-bold text-[#619bd1]">점</span></div>
                    <div class="feedback-box"><p id="feedback-text" class="text-[13px] text-slate-600 font-medium leading-relaxed"></p></div>
                </div>
            </div>
            <div class="mt-auto pt-8 text-center"><p id="error-log" class="text-red-400 text-[10px] mb-4 h-4 font-medium px-4"></p></div>
        </section>
    </div>

    <script>
        const displayChars = ["あ", "い", "う", "え", "お"];
        let currentTarget = "あ";
        let hasDrawn = false;
        let isProcessing = false;
        let charScores = { "あ": null, "い": null, "う": null, "え": null, "お": null };

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width; canvas.height = rect.height;
            ctx.lineCap = 'round'; ctx.lineWidth = 10; ctx.strokeStyle = '#1e293b';
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        window.addEventListener('load', () => { initCanvas(); renderTabs(); });

        function renderTabs() {
            const container = document.getElementById('char-selection');
            container.innerHTML = '';
            displayChars.forEach(c => {
                const item = document.createElement('div');
                item.className = 'char-item';
                const badge = document.createElement('div');
                badge.className = `score-badge ${charScores[c] !== null ? 'visible' : ''}`;
                badge.innerText = charScores[c] !== null ? `${charScores[c]}점` : '';
                const btn = document.createElement('button');
                btn.className = `char-btn ${c === currentTarget ? 'active' : ''}`;
                btn.innerText = c;
                btn.onclick = () => { if(isProcessing) return; currentTarget = c; clearCanvas(); renderTabs(); };
                item.appendChild(badge); item.appendChild(btn); container.appendChild(item);
            });
        }

        function clearCanvas() {
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            document.getElementById('view-idle').classList.remove('hidden');
            document.getElementById('view-result').classList.add('hidden');
            document.getElementById('error-log').innerText = '';
        }

        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: cx - rect.left, y: cy - rect.top };
        };

        canvas.addEventListener('mousedown', (e) => { if(isProcessing) return; isDrawing = true; hasDrawn = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', (e) => { if(!isDrawing || isProcessing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); });
        window.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); if(isProcessing) return; isDrawing = true; hasDrawn = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(!isDrawing || isProcessing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); }, {passive: false});
        canvas.addEventListener('touchend', () => isDrawing = false);

        // ✅ 백엔드 주소 자동 매칭 (가장 안전한 방법)
        const SERVER_URL = window.location.origin + "/api/score";

        async function performAiAnalysis() {
            if(!hasDrawn || isProcessing) return;
            isProcessing = true;
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('btn-text').innerText = '분석 중...';
            document.getElementById('error-log').innerText = '';

            const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: currentTarget, imageData })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText.includes('page could not be found') ? '서버 연결 실패 (URL 오류)' : 'AI 응답 오류');
                }

                const result = await response.json();
                charScores[currentTarget] = result.score;
                document.getElementById('score-val').innerText = result.score;
                document.getElementById('feedback-text').innerText = result.feedback;
                document.getElementById('view-idle').classList.add('hidden');
                document.getElementById('view-result').classList.remove('hidden');
                renderTabs();
            } catch (err) {
                console.error(err);
                document.getElementById('error-log').innerText = '오류: ' + err.message;
            } finally {
                isProcessing = false;
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('btn-text').innerText = '채점하기';
            }
        }

        document.getElementById('submit-btn').onclick = performAiAnalysis;
        document.getElementById('clear-btn').onclick = clearCanvas;
    </script>
</body>
</html>
